<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
  <script>
    const SUPABASE_URL = "https://jquxvpsjqpnuzxkxintu.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpxdXh2cHNqcXBudXp4a3hpbnR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI5MTI1NDgsImV4cCI6MjA1ODQ4ODU0OH0.7iN9_8cm-eMJv_duarRdAIW08khGWqpvcMuQahycK3I";
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

<title>ç¬¬â—‹å›ã‚®ãƒ«ãƒ‰ãƒãƒˆãƒ«æ¨¡æ“¬æˆ¦çµæœä¸€è¦§</title>

  <!-- ãƒ•ã‚©ãƒ³ãƒˆã¨ã‚¢ã‚¤ã‚³ãƒ³èª­ã¿è¾¼ã¿ -->
  <link href="https://fonts.googleapis.com/css2?family=Sawarabi+Gothic&family=Orbitron&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet" />

  <style>
    body {
      font-family: 'Sawarabi Gothic', 'Orbitron', sans-serif;
      text-align: center;
      background-color: #1a1a1a;
      color: #fff;
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      text-shadow: 0 0 4px rgba(255,255,255,0.4), 0 0 8px rgba(255,255,255,0.3);
    }

    h1, h2, h3, h4, h5, h6, .scroll-text, .menu-header, .menu-button, .digital-clock {
      font-family: 'Sawarabi Gothic', 'Orbitron', sans-serif;
      text-shadow: 0 0 4px rgba(255,255,255,0.4), 0 0 8px rgba(255,255,255,0.3);
    }

    .scroll-container {
      width: 100%;
      overflow: hidden;
      background-color: #000;
      padding: 10px 0;
      margin-bottom: 10px;
    }

    .scroll-text {
      display: inline-block;
      white-space: nowrap;
      animation: scrollText 20s linear infinite;
      font-family: 'DotGothic16', monospace;
      font-size: 24px;
      text-shadow: 0 0 10px #FFA500, 0 0 20px #FF4500;
    }

    .fixed-text { color: #FFA500; }

    h2 {
  ã€€ã€€font-size: 26px;
  ã€€ã€€font-weight: bold;
  ã€€ã€€text-shadow: 0 0 4px #fff, 0 0 8px #0ff, 0 0 12px #0ff;
  ã€€ã€€margin-bottom: 20px;
ã€€ã€€}

    .variable-text { color: #FF3333; }

    @keyframes scrollText {
      0% { transform: translateX(100%); opacity: 0; }
      5% { opacity: 1; }
      95% { opacity: 1; }
      100% { transform: translateX(-100%); opacity: 0; }
    }

    table {
      width: 90%;
      margin: auto;
      border-collapse: collapse;
      background-color: rgba(0, 0, 0, 0.6);
    }

    th, td {
      border: 1px solid #444;
      padding: 8px;
      text-align: center;
      position: relative;
    }

    th {
      background-color: #333;
    }

    .search-button {
      position: absolute;
      top: 5px;
      right: 5px;
      padding: 2px 5px;
      font-size: 10px;
      background-color: #4CAF50;
      color: #fff;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }

    .player-name { font-size: 16px; font-weight: bold; }
    .player-info { font-size: 12px; color: #aaa; }

    .gauge-wrapper { width: 120px; margin: auto; }
    .gauge-container { position: relative; height: 12px; background-color: #555; border-radius: 5px; width: 100%; }
    .gauge-bar { height: 100%; background-color: #4CAF50; border-radius: 5px 0 0 5px; }
    .gauge-ticks { position: absolute; top: 0; left: 0; height: 100%; width: 100%; display: flex; justify-content: space-between; }
    .gauge-ticks div { width: 1px; background-color: #aaa; }
    .gauge-labels { display: flex; justify-content: space-between; font-size: 8px; color: #ccc; margin-top: 2px; }

    .difficulty-label { font-size: 10px; margin-top: 4px; color: #ccc; }
    .difficulty { display: flex; justify-content: center; margin-top: 2px; }
    .difficulty span { font-size: 12px; margin: 0 1px; }
    .difficulty .special { color: yellow; }
    .difficulty .transparent { opacity: 0.3; }

    .battle-times { display: flex; justify-content: center; gap: 4px; font-size: 16px; }

    .update-button {
      margin-top: 5px;
      padding: 5px 10px;
      font-size: 12px;
      background-color: #2196F3;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .update-button:hover { background-color: #1976D2; }

    .update-time { font-size: 10px; color: #ccc; margin-top: 4px; }

    .challenge-header { background-color: #333; color: #FFA500; }

    .challenge-btn {
      width: 30px;
      height: 30px;
      margin: 2px;
      background-color: #555;
      color: #fff;
      border: 1px solid #fff;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .challenge-btn.active {
      background-color: #fff;
      color: #000;
      font-weight: bold;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

    .modal-content {
      background-color: #222;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      width: 300px;
    }

    .modal-content label, .modal-content select, .modal-content input {
      display: block;
      margin: 10px auto;
      width: 80%;
    }

    .modal-content button {
      margin: 5px;
      padding: 5px 10px;
      background-color: #4CAF50;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .modal-content button.close-btn { background-color: #888; }
    .modal-content button.reset-btn { background-color: #FF3333; }

    /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
    body {
      display: flex;
      margin: 0;
      font-family: 'Noto Sans JP', sans-serif;
      background-color: #1a1a1a;
      color: #fff;
    }

    .sidebar {
      width: 240px;
      background-color: #2c2c2c;
      height: 100vh;
      padding: 20px 15px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      position: fixed;
      left: 0;
      top: 0;
    }

    .login-id-box {
      border: 2px solid yellow;
      background-color: #1a1a1a;
      padding: 10px;
      margin-bottom: 30px;
      color: yellow;
      width: 100%;
      text-align: center;
      font-size: 14px;
      box-sizing: border-box;
      border-radius: 5px;
    }

    .menu-header {
      color: #fff;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      font-size: 16px;
      font-weight: bold;
    }

    .menu-header i {
      margin-right: 10px;
    }

    .menu-button {
      width: 100%;
      padding: 12px 15px;
      margin-bottom: 15px;
      background-color: #2196F3;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      display: flex;
      align-items: center;
      font-size: 15px;
      transition: background-color 0.3s;
      text-decoration: none;
    }

    .menu-button i {
      margin-right: 10px;
      font-size: 18px;
    }

    .menu-button:hover {
      background-color: #1976D2;
    }

    .main-content {
      margin-left: 240px;
      padding: 20px;
      flex: 1;
      box-sizing: border-box;
    }

    .digital-clock {
      font-family: 'Orbitron', sans-serif;
      font-size: 16px;
      color: #0ff;
      text-align: center;
      padding-top: 20px;
      line-height: 1.6;
      text-shadow: 0 0 5px #0ff, 0 0 10px #0ff;
    }

    .digital-clock .clock-time {
      font-size: 22px;
      font-weight: bold;
      display: block;
      text-shadow: 0 0 6px #0ff, 0 0 15px #0ff;
    }

    .digital-clock .clock-date {
      font-size: 16px;
      display: block;
    }

/* â–¼â–¼â–¼ ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œï¼šã‚¹ãƒãƒ›ã‚„ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå‘ã‘ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ â–¼â–¼â–¼ */
@media (max-width: 768px) {

  /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’ä¸Šã«ç§»å‹•ã—ã¦æ¨ªä¸¦ã³ã« */
  body {
    flex-direction: column;
  }

  .sidebar {
    position: relative;
    width: 100%;
    height: auto;
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: space-around;
    align-items: center;
    padding: 10px;
  }

  .login-id-box {
    font-size: 12px;
    margin-bottom: 10px;
    width: auto;
  }

  .menu-button {
    font-size: 14px;
    padding: 10px 8px;
    margin-bottom: 10px;
    flex: none;
    width: auto;
  }

  .main-content {
    margin-left: 0;
    margin-top: 10px;
    padding: 10px;
  }

  .scroll-text {
    font-size: 18px;
  }

  /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã«ã™ã‚‹ */
  table {
    display: block;
    overflow-x: auto;
    white-space: nowrap;
  }

  th, td {
    font-size: 12px;
    padding: 6px;
  }

  .player-name {
    font-size: 14px;
  }

  .player-info {
    font-size: 10px;
  }

  .gauge-wrapper {
    width: 100px;
  }

  .battle-times {
    font-size: 14px;
  }

  .update-button {
    font-size: 11px;
    padding: 4px 8px;
  }

  .digital-clock {
    font-size: 14px;
    padding-top: 10px;
  }

  .digital-clock .clock-time {
    font-size: 18px;
  }

  .digital-clock .clock-date {
    font-size: 14px;
  }
}

/* â–²â–²â–² ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œã“ã“ã¾ã§ â–²â–²â–² */


  </style>
</head>

<body>

  <!-- â–¼ ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
  <div class="sidebar">
    <div class="login-id-box" id="loginIdBox">ãƒ­ã‚°ã‚¤ãƒ³ID: å–å¾—ä¸­...</div>

    <div class="menu-header"><i class="fas fa-bars"></i> ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>

    <button class="menu-button" onclick="navigatePage('guild_home.html')">
      <i class="fas fa-house"></i> ãƒ›ãƒ¼ãƒ 
    </button>

    <button class="menu-button" onclick="navigatePage('guild_battle_input.html')">
      <i class="fas fa-pen-to-square"></i> ãƒ‡ãƒ¼ã‚¿å…¥åŠ›
    </button>

    <button class="menu-button" onclick="navigatePage('guild_master.html')">
      <i class="fas fa-cogs"></i> ãƒã‚¹ã‚¿ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹
    </button>

    <div id="datetimeDisplay" class="digital-clock"></div>

  </div>

  <!-- â–¼ ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div class="main-content">
    <!-- âœ… ã“ã“ã«å®Œæˆãƒšãƒ¼ã‚¸ã®HTMLã‚’æŒ¿å…¥ã™ã‚‹ -->

  <h2 id="pageTitle">ç¬¬â—‹å›ã‚®ãƒ«ãƒ‰ãƒãƒˆãƒ«æ¨¡æ“¬æˆ¦çµæœä¸€è¦§ãƒšãƒ¼ã‚¸</h2>

  <div class="scroll-container">
    <div class="scroll-text" id="scrollInfo"></div>
  </div>

  <div id="searchModal" class="modal">
    <div class="modal-content">
      <h3 id="modalTitle">STGæ¤œç´¢</h3>
      <label for="searchValue">ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆ</label>
      <input type="number" id="searchValue" min="0" max="100">
      <label for="searchCondition">æ¡ä»¶</label>
      <select id="searchCondition">
        <option value="equal">ï¼</option>
        <option value="greater">ï¼ï¼ï¼ˆä»¥ä¸Šï¼‰</option>
        <option value="less">ï¼œï¼ï¼ˆä»¥ä¸‹ï¼‰</option>
      </select>
      <button onclick="applySearch()">OK</button>
      <button class="reset-btn" onclick="resetSearch()">ãƒªã‚»ãƒƒãƒˆ</button>
      <button class="close-btn" onclick="closeModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th rowspan="2">ãƒ¡ãƒ³ãƒãƒ¼</th>
        <th rowspan="2">STG6
          <button class="search-button" onclick="openModal('stg6')">æ¤œç´¢</button>
          <div class="difficulty-label">é›£æ˜“åº¦</div>
          <div class="difficulty">
            <span class="special">ğŸ’€</span><span>ğŸ’€</span><span>ğŸ’€</span><span>ğŸ’€</span><span>ğŸ’€</span><span>ğŸ’€</span>
          </div>
        </th>
        <th rowspan="2">STG5
          <button class="search-button" onclick="openModal('stg5')">æ¤œç´¢</button>
          <div class="difficulty-label">é›£æ˜“åº¦</div>
          <div class="difficulty">
            <span>ğŸ’€</span><span>ğŸ’€</span><span>ğŸ’€</span><span>ğŸ’€</span><span>ğŸ’€</span><span class="transparent">ğŸ’€</span>
          </div>
        </th>
        <th rowspan="2">STG4
          <button class="search-button" onclick="openModal('stg4')">æ¤œç´¢</button>
          <div class="difficulty-label">é›£æ˜“åº¦</div>
          <div class="difficulty">
            <span>ğŸ’€</span><span>ğŸ’€</span><span>ğŸ’€</span><span>ğŸ’€</span><span class="transparent">ğŸ’€</span><span class="transparent">ğŸ’€</span>
          </div>
        </th>
        <th rowspan="2">STG3
          <button class="search-button" onclick="openModal('stg3')">æ¤œç´¢</button>
          <div class="difficulty-label">é›£æ˜“åº¦</div>
          <div class="difficulty">
            <span>ğŸ’€</span><span>ğŸ’€</span><span>ğŸ’€</span><span class="transparent">ğŸ’€</span><span class="transparent">ğŸ’€</span><span class="transparent">ğŸ’€</span>
          </div>
        </th>
        <th rowspan="2">STG2
          <button class="search-button" onclick="openModal('stg2')">æ¤œç´¢</button>
          <div class="difficulty-label">é›£æ˜“åº¦</div>
          <div class="difficulty">
            <span>ğŸ’€</span><span>ğŸ’€</span><span class="transparent">ğŸ’€</span><span class="transparent">ğŸ’€</span><span class="transparent">ğŸ’€</span><span class="transparent">ğŸ’€</span>
          </div>
        </th>
        <th rowspan="2">STG1
          <button class="search-button" onclick="openModal('stg1')">æ¤œç´¢</button>
          <div class="difficulty-label">é›£æ˜“åº¦</div>
          <div class="difficulty">
            <span>ğŸ’€</span><span class="transparent">ğŸ’€</span><span class="transparent">ğŸ’€</span><span class="transparent">ğŸ’€</span><span class="transparent">ğŸ’€</span><span class="transparent">ğŸ’€</span>
          </div>
        </th>
        <th rowspan="2">å‚åŠ æ™‚é–“</th>
        <th rowspan="2">æ›´æ–°æ™‚é–“</th>
        <th rowspan="2">æ“ä½œ</th>
        <th colspan="3" class="challenge-header">æœ¬æˆ¦æŒ‘æˆ¦çŠ¶æ³</th>
      </tr>
      <tr>
        <th>1æ—¥ç›®</th>
        <th>2æ—¥ç›®</th>
        <th>æœ€çµ‚æ—¥</th>
      </tr>
    </thead>
    <tbody id="memberTableBody"></tbody>
  </table>

  </div>

  <script>
    // ãƒ­ã‚°ã‚¤ãƒ³IDã‚’å–å¾—
    const urlParams = new URLSearchParams(window.location.search);
    const loginId = urlParams.get('loginId') || 'æœªå–å¾—';
    document.getElementById('loginIdBox').textContent = `ãƒ­ã‚°ã‚¤ãƒ³ID: ${loginId}`;

    // ãƒšãƒ¼ã‚¸é·ç§»æ™‚ã«loginIdã‚’æ¸¡ã™
   function navigatePage(page) {
     if (page === 'guild_battle_input.html' && !(loginRole === 'GM' || loginRole === 'SM')) {
       alert('ã“ã®ãƒšãƒ¼ã‚¸ã¸ã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ï¼ˆã‚®ãƒ«ãƒã‚¹ãƒ»ã‚µãƒ–ãƒã‚¹é™å®šï¼‰');
       return;
     }
     if (page === 'guild_master.html' && loginRole !== 'GM') {
       alert('ã“ã®ãƒšãƒ¼ã‚¸ã¸ã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ï¼ˆã‚®ãƒ«ãƒã‚¹é™å®šï¼‰');
       return;
     }
     window.location.href = `${page}?loginId=${loginId}`;
   }
    // âœ… ã“ã“ã«å®Œæˆãƒšãƒ¼ã‚¸ã®JSã‚’æŒ¿å…¥ã™ã‚‹

    let guildMembers = [];
    let battleRecords = [];
    let challengeStatus = {};
    let currentRound = 0;
    let loginRole = "member"; // åˆæœŸå€¤ã‚’è¨­å®š

    const scrollInfo = document.getElementById('scrollInfo');
    const tableBody = document.getElementById('memberTableBody');
    const searchModal = document.getElementById('searchModal');
    const modalTitle = document.getElementById('modalTitle');
    const searchValueInput = document.getElementById('searchValue');
    const searchConditionSelect = document.getElementById('searchCondition');

    let searchTarget = '';
    
// ğŸ”¹ 1ï¸âƒ£ ã‚®ãƒ«ãƒ‰ãƒãƒˆãƒ«ã®é–‹å‚¬æƒ…å ±ã‚’å–å¾—
async function fetchOngoingBattle() {
    const { data, error } = await db
        .from('guild_battle_settings')
        .select('*')
        .eq('status', 'ongoing')
        .single();

    if (error || !data) {
        console.error("ã‚®ãƒ«ãƒ‰ãƒãƒˆãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
        alert('é–‹å‚¬ä¸­ã®ã‚®ãƒ«ãƒ‰ãƒãƒˆãƒ«ãŒã‚ã‚Šã¾ã›ã‚“');
        return null;
    }
    
    console.log("å–å¾—ã—ãŸã‚®ãƒ«ãƒ‰ãƒãƒˆãƒ«:", data); // âœ… ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
    return data;
}

// ğŸ”¹ 2ï¸âƒ£ ã‚®ãƒ«ãƒ‰ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’å–å¾—
async function fetchGuildMembers() {
    const { data, error } = await db
        .from('guild_members')
        .select('*');

    if (error) {
        console.error('ãƒ¡ãƒ³ãƒãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        return [];
    }
    return data;
}

// ğŸ”¹ 3ï¸âƒ£ ãƒãƒˆãƒ«çµæœã‚’å–å¾—
async function fetchBattleRecords(round) {
    console.log(`ğŸ” Fetching battle records for round: ${round}`);
    const { data, error } = await db
        .from('guild_battle_records')
        .select('*')
        .eq('round', round);  // ğŸ‘ˆ roundã‚’æ–‡å­—åˆ—ã§ã¯ãªãæ•°å€¤ã¨ã—ã¦æ¤œç´¢

    if (error) {
        console.error('ãƒãƒˆãƒ«çµæœå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        return [];
    }
    return data;
}

// ğŸ”¹ 4ï¸âƒ£ æŒ‘æˆ¦çŠ¶æ³ã‚’å–å¾—
async function fetchChallengeStatus() {
    const { data, error } = await db
        .from('challenge_status')
        .select('*');

    if (error) {
        console.error('æŒ‘æˆ¦çŠ¶æ³å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        return {};
    }

    let status = {};
    data.forEach(row => {
        status[row.member_id] = {
            day1: row.day1 || [],
            day2: row.day2 || [],
            day3: row.day3 || []
        };
    });

    return status;
}

let ongoingBattle = null;  // âœ… ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦å®šç¾©

// ğŸ”¹ 5ï¸âƒ£ ãƒšãƒ¼ã‚¸åˆæœŸåŒ–å‡¦ç†
async function initializePage() {
    // 1ï¸âƒ£ é–‹å‚¬ä¸­ã®ã‚®ãƒ«ãƒ‰ãƒãƒˆãƒ«ã‚’å–å¾—
    ongoingBattle = await fetchOngoingBattle();  // âœ… ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä»£å…¥
    if (!ongoingBattle) return;
    currentRound = parseInt(ongoingBattle.round.replace('ç¬¬', '').replace('å›', ''), 10) || 0;
    console.log("âœ… å–å¾—ã—ãŸã‚®ãƒ«ãƒ‰ãƒãƒˆãƒ«:", ongoingBattle);
    console.log("ğŸ” ä¿®æ­£å¾Œã® round:", currentRound);
    
    // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«è¨­å®š
    document.getElementById('pageTitle').textContent = `${ongoingBattle.round}ã‚®ãƒ«ãƒ‰ãƒãƒˆãƒ«æ¨¡æ“¬æˆ¦çµæœä¸€è¦§ãƒšãƒ¼ã‚¸`;

    // **èƒŒæ™¯ç”»åƒã®è¨­å®š**
    if (ongoingBattle.bg_image_url) { // ğŸ”¹ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åã‚’ç¢ºèª
        document.body.style.backgroundImage = `url('${ongoingBattle.bg_image_url}')`;
        console.log("âœ… èƒŒæ™¯ç”»åƒãŒè¨­å®šã•ã‚Œã¾ã—ãŸ:", ongoingBattle.bg_image_url);
    } else {
        console.warn("âš ï¸ èƒŒæ™¯ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“");
    } 
  
 // 2ï¸âƒ£ ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ãƒ»ãƒãƒˆãƒ«è¨˜éŒ²ãƒ»æŒ‘æˆ¦çŠ¶æ³ã‚’å–å¾—
    guildMembers = await fetchGuildMembers();
    battleRecords = await fetchBattleRecords(currentRound);
    challengeStatus = await fetchChallengeStatus();

    // 3ï¸âƒ£ ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½¹å‰²ã‚’è¨­å®šï¼ˆã“ã“ã§è¡Œã†ï¼‰
    const loginMember = guildMembers.find(m => m.id === loginId);
    loginRole = loginMember?.role || 'member';

    console.log("ã‚®ãƒ«ãƒ‰ãƒ¡ãƒ³ãƒãƒ¼:", guildMembers);
    console.log("ãƒãƒˆãƒ«è¨˜éŒ²:", battleRecords);
    console.log("æŒ‘æˆ¦çŠ¶æ³:", challengeStatus);
  
 ã€€ if (!guildMembers.length || !battleRecords.length) {
        console.warn("ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ");
        return;
    }

    // **ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®æƒ…å ±ã‚’æ›´æ–°**
    let enemyTarget = ongoingBattle.enemy_target || "???";
    let attributes = Array.isArray(ongoingBattle.attributes) ? ongoingBattle.attributes.join(' / ') : "ä¸æ˜";
    let type = Array.isArray(ongoingBattle.type) ? ongoingBattle.type.join(' / ') : "ä¸æ˜";

    scrollInfo.innerHTML = `<span class="fixed-text">ğŸŸ¢ ã‚®ãƒ«ãƒ‰ãƒãƒˆãƒ«æƒ…å ± â¤ ãƒœã‚¹ã‚¨ãƒãƒŸãƒ¼:</span> 
    <span class="variable-text">${enemyTarget}</span> 
    <span class="fixed-text">ï½œ å¼±ç‚¹å±æ€§:</span> 
    <span class="variable-text">${attributes}</span> 
    <span class="fixed-text">ï½œ å¼±ç‚¹ç¨®åˆ¥:</span> 
    <span class="variable-text">${type}</span> 
    <span class="fixed-text">ğŸŸ¢</span>`;

    console.log("âœ… ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼æƒ…å ±:", scrollInfo.innerHTML);
  
    // 4ï¸âƒ£ ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æç”»
    renderTable();
}

ã€€ã€€// ğŸ”¹ 6ï¸âƒ£ ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
ã€€ã€€window.onload = initializePage;

    function openModal(target) {
      searchTarget = target;
      modalTitle.textContent = `${target.toUpperCase()} æ¤œç´¢`;
      searchModal.style.display = 'flex';
    }

    function closeModal() {
      searchModal.style.display = 'none';
    }

    function applySearch() {
      const value = Number(searchValueInput.value);
      const condition = searchConditionSelect.value;

      if (isNaN(value)) {
        alert('ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      const filteredMembers = guildMembers.filter(member => {
        const record = battleRecords.find(r =>
          r.id === member.id &&
          ongoingBattle &&
          r.round === Number(ongoingBattle.round.replace('ç¬¬', '').replace('å›', ''))
        );
        if (!record) return false;

        const targetValue = Number(record[searchTarget]) || 0;
        if (condition === 'equal') return targetValue === value;
        if (condition === 'greater') return targetValue >= value;
        if (condition === 'less') return targetValue <= value;
        return false;
      });

      renderTable(filteredMembers);
      closeModal();
    }

    function resetSearch() {
      renderTable(guildMembers);
      closeModal();
    }

    function toggleChallenge(memberId, day, slot) {
      if (!challengeStatus[memberId]) challengeStatus[memberId] = {};
      if (!challengeStatus[memberId][`day${day}`]) challengeStatus[memberId][`day${day}`] = {};
      challengeStatus[memberId][`day${day}`][slot] = !challengeStatus[memberId][`day${day}`][slot];
      localStorage.setItem('challengeStatus', JSON.stringify(challengeStatus));
      renderTable(guildMembers);
    }

    function renderChallengeButtons(memberId, day) {
        const buttons = [];
        const slots = challengeStatus[memberId]?.[`day${day}`] || {};

        for (let i = 1; i <= 3; i++) {
            const slotKey = `slot${i}`;
            const active = slots[slotKey] === true; // ğŸ”¹ JSONå†…ã®ã‚­ãƒ¼ã‚’æ˜ç¤ºçš„ã«æŒ‡å®š

            buttons.push(`<button class="challenge-btn ${active ? 'active' : ''}" onclick="toggleChallenge('${memberId}', ${day}, ${i})">${i}</button>`);
        }
        return buttons.join('');
    }    
    
    function renderTable(members = guildMembers) {
      tableBody.innerHTML = '';
      members.forEach(member => {
        const row = document.createElement('tr');
        const record = battleRecords.find(r => r.id === member.id && ongoingBattle && r.round === Number(ongoingBattle.round.replace('ç¬¬', '').replace('å›', '')));

        const playerCell = document.createElement('td');
        playerCell.innerHTML = `<div class="player-name">${member.name}</div><div class="player-info">Lv.${member.level} / æˆ¦åŠ› ${member.power}</div>`;
        row.appendChild(playerCell);

        const stages = record ? [record.stg6, record.stg5, record.stg4, record.stg3, record.stg2, record.stg1] : [0, 0, 0, 0, 0, 0];
        stages.forEach(percent => {
          const cell = document.createElement('td');
          cell.innerHTML = `
            ${percent}%
            <div class="gauge-wrapper">
              <div class="gauge-container">
                <div class="gauge-bar" style="width: ${percent}%;"></div>
                <div class="gauge-ticks"><div></div><div></div><div></div><div></div><div></div></div>
              </div>
              <div class="gauge-labels"><span>0%</span><span>25%</span><span>50%</span><span>75%</span><span>100%</span></div>
            </div>`;
          row.appendChild(cell);
        });

    const timeIcons = { "æ—©æœ": "ğŸŒ…", "æœ": "â˜€ï¸", "æ˜¼": "ğŸŒ", "å¤œ": "ğŸŒ™", "æ·±å¤œ": "ğŸŒŒ" };
    const timesCell = document.createElement('td');

// `record.times` ã‚’JSONã¨ã—ã¦è§£æ
let battleTimes = [];
try {
    battleTimes = record?.times ? JSON.parse(record.times) : [];
} catch (e) {
    console.error("âŒ å‚åŠ æ™‚é–“ã®è§£æã‚¨ãƒ©ãƒ¼:", e);
}

timesCell.innerHTML = battleTimes.length
    ? `<div class="battle-times">${battleTimes.map(t => timeIcons[t] || 'â“').join('')}</div>`
    : '-';
row.appendChild(timesCell);

const updateTimeCell = document.createElement('td');
updateTimeCell.innerHTML = `<div class="update-time">${record?.updated_at || '-'}</div>`;
row.appendChild(updateTimeCell);

const actionCell = document.createElement('td');
if (member.id === loginId) {
  const btn = document.createElement('button');
  btn.className = 'update-button';
  btn.textContent = 'æ›´æ–°';
  btn.onclick = () => window.location.href = `guild_battle_input.html?id=${member.id}&loginId=${loginId}`;
  actionCell.appendChild(btn);
} else {
  actionCell.innerHTML = '-';
}
row.appendChild(actionCell);


if (loginRole === 'GM' || loginRole === 'SM') {
  for (let d = 1; d <= 3; d++) {
    const td = document.createElement('td');
    td.innerHTML = renderChallengeButtons(member.id, d);
    row.appendChild(td);
  }
}
        tableBody.appendChild(row);
      });
    }


    renderTable();

function updateDateTime() {
  const datetimeDisplay = document.getElementById('datetimeDisplay');
  const now = new Date();

  const yyyy = now.getFullYear();
  const mm = String(now.getMonth() + 1).padStart(2, '0');
  const dd = String(now.getDate()).padStart(2, '0');
  const dayIndex = now.getDay();
  const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

  const hh = String(now.getHours()).padStart(2, '0');
  const mi = String(now.getMinutes()).padStart(2, '0');
  const ss = String(now.getSeconds()).padStart(2, '0');

  let color = '';
  if (dayIndex === 0) color = 'red';
  else if (dayIndex === 6) color = 'blue';

  const day = `<span style="color:${color}; font-weight:bold;">(${dayNames[dayIndex]})</span>`;
  datetimeDisplay.innerHTML = `
    <span class="clock-date">${yyyy}/${mm}/${dd} ${day}</span>
    <span class="clock-time">${hh}:${mi}:${ss}</span>
  `;
}

// åˆå›è¡¨ç¤ºã¨1ç§’ã”ã¨ã®æ›´æ–°
updateDateTime();
setInterval(updateDateTime, 1000);

  </script>

</body>
</html>
